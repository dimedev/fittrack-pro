<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Connexion... | REPZY</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../../favicon.svg">
    <link rel="apple-touch-icon" href="../../apple-touch-icon.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="../../css/auth.css">
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <!-- Logo -->
            <div class="auth-logo">
                <div class="auth-logo-text">REP<span>ZY</span></div>
            </div>
            
            <!-- Loader -->
            <div class="auth-loader-container" id="loader">
                <div class="auth-loader"></div>
                <p class="auth-loader-text">Connexion en cours...</p>
            </div>
            
            <!-- Error state (hidden by default) -->
            <div id="error-state" style="display: none;">
                <div class="auth-message error" id="error-message">
                    Une erreur est survenue
                </div>
                <div class="auth-links" style="margin-top: 24px;">
                    <a href="../../index.html" class="auth-link">Retour à l'accueil</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== AUTH CALLBACK HANDLER ====================
        
        // Configuration Supabase
        const SUPABASE_URL = 'https://erszjvaajztewcukvwbj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyc3pqdmFhanp0ZXdjdWt2d2JqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5ODAzNjAsImV4cCI6MjA4NDU1NjM2MH0.jK2keM5VtaLkGR8kD2xhjEgqzmfymdNVmbw509ZO2t4';
        
        // Initialize Supabase client
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // DOM Elements
        const loader = document.getElementById('loader');
        const errorState = document.getElementById('error-state');
        const errorMessage = document.getElementById('error-message');
        
        /**
         * Show error state
         */
        function showError(message) {
            loader.style.display = 'none';
            errorState.style.display = 'block';
            errorMessage.textContent = message;
        }
        
        /**
         * Check if user is new (first login)
         */
        function isNewUser(user) {
            if (!user) return false;
            
            // Compare created_at and last_sign_in_at
            // If they're very close (within 10 seconds), it's a new user
            const createdAt = new Date(user.created_at).getTime();
            const lastSignIn = new Date(user.last_sign_in_at).getTime();
            const diff = Math.abs(lastSignIn - createdAt);
            
            return diff < 10000; // 10 seconds threshold
        }
        
        /**
         * Redirect to main app
         */
        function redirectToApp(isNew = false) {
            // Store new user flag in sessionStorage for wizard trigger
            if (isNew) {
                sessionStorage.setItem('repzy_new_user', 'true');
            }
            
            // Redirect to main app
            window.location.href = '../../index.html';
        }
        
        // Track if we've already handled the auth
        let authHandled = false;
        
        /**
         * Handle successful authentication
         */
        function handleAuthSuccess(session) {
            if (authHandled) return;
            authHandled = true;
            
            const newUser = isNewUser(session.user);
            console.log('✅ Auth callback successful', { 
                newUser, 
                email: session.user.email,
                provider: session.user.app_metadata?.provider 
            });
            redirectToApp(newUser);
        }
        
        /**
         * Handle network errors
         */
        function handleNetworkError() {
            if (!navigator.onLine) {
                showError('Pas de connexion internet. Vérifiez votre réseau.');
            }
        }
        
        // Listen for auth state changes (this is the reliable way for OAuth)
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('Auth event:', event, session ? 'has session' : 'no session');
            
            if (event === 'SIGNED_IN' && session) {
                handleAuthSuccess(session);
            } else if (event === 'TOKEN_REFRESHED' && session) {
                handleAuthSuccess(session);
            } else if (event === 'SIGNED_OUT') {
                showError('Session expirée. Veuillez vous reconnecter.');
            }
        });
        
        // Also check for existing session on load
        document.addEventListener('DOMContentLoaded', async () => {
            // Check network first
            if (!navigator.onLine) {
                handleNetworkError();
                return;
            }
            
            // Check if URL has hash with tokens (OAuth callback)
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const hasAuthTokens = hashParams.has('access_token') || hashParams.has('error');
            
            if (hasAuthTokens) {
                // Let Supabase handle the hash - onAuthStateChange will fire
                console.log('OAuth tokens detected in URL, waiting for Supabase...');
                return;
            }
            
            // No hash tokens, check for existing session
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    console.error('Session error:', error);
                    showError('Erreur lors de la récupération de la session');
                    return;
                }
                
                if (session) {
                    handleAuthSuccess(session);
                } else {
                    // No session and no tokens - invalid state
                    showError('Session invalide ou expirée');
                }
            } catch (err) {
                console.error('Callback error:', err);
                showError('Une erreur inattendue est survenue');
            }
        });
        
        // Listen for online/offline events
        window.addEventListener('offline', handleNetworkError);
        
        // Timeout fallback - redirect after 8 seconds even if something fails
        setTimeout(() => {
            if (!authHandled && loader.style.display !== 'none') {
                console.warn('Callback timeout - redirecting anyway');
                redirectToApp(false);
            }
        }, 8000);
    </script>
</body>
</html>
